name: CI

on:
  push:
    branches: [master, main]
    tags:
      - 'client-v*'
      - 'service-v*'
  pull_request:

env:
  TAG_VERSION: "v1-latest"
  DOCKER_REPO_NAME: "backenddevelopersltd/bittensor-pylon"

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: [pylon_commons, pylon_client]
        python-version: ['3.11']
        include:
          - package: pylon_service
            python-version: '3.13'
    name: lint (${{ matrix.package }})
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup python env
        uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ matrix.python-version }}

      - name: Run linting checks with nox
        run: cd ${{ matrix.package }} && nox -s lint

  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: [pylon_commons, pylon_client]
        python-version: ['3.11', '3.12', '3.13', '3.14']
        include:
          - package: pylon_service
            python-version: '3.13'
            nox-session: test
    name: unit-tests (${{ matrix.package }}, py${{ matrix.python-version }})
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup python env
        uses: ./.github/actions/setup-python-env
        with:
          python-version: ${{ matrix.python-version }}

      - name: Run unit tests with nox
        env:
          PYLON_DOCKER_IMAGE_NAME: ${{ env.DOCKER_REPO_NAME }}:${{ env.TAG_VERSION }}
        run: cd ${{ matrix.package }} && nox -s ${{ matrix.nox-session || format('test-{0}', matrix.python-version) }}

  test-docker-build:
    runs-on: ubuntu-latest
    name: test-docker-build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test Docker image builds
        uses: docker/build-push-action@v5
        with:
          context: .
          file: pylon_service/Dockerfile
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

  test-client-build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        build-type: [sdist, wheel, both]
        include:
          - build-type: sdist
            build-args: "--sdist"
          - build-type: wheel
            build-args: "--wheel"
          - build-type: both
            build-args: ""
    name: test-client-build (${{ matrix.build-type }})
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v6

      - name: Test ${{ matrix.build-type }} build
        run: cd pylon_client && uv build ${{ matrix.build-args }}

  pact-tests-client:
    runs-on: ubuntu-latest
    name: pact-tests-client
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup python env
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.14'

      - name: Run client pact tests
        run: cd pylon_client && nox -s test-pact

      - name: Upload pact files
        uses: actions/upload-artifact@v4
        with:
          name: pact-files
          path: pylon_client/tests/pact/pacts/
          retention-days: 1

  pact-tests-service:
    runs-on: ubuntu-latest
    name: pact-tests-service
    needs: [pact-tests-client]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup python env
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.13'

      - name: Download pact files
        uses: actions/download-artifact@v4
        with:
          name: pact-files
          path: pact-files/

      - name: Run service pact verification
        env:
          PACT_FILES_DIR: ${{ github.workspace }}/pact-files
        run: cd pylon_service && nox -s test-pact


